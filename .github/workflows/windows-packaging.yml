name: Windows packaging

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install NSIS (if needed)
        shell: pwsh
        run: |
          choco install nsis -y
          $chocBin = 'C:\ProgramData\chocolatey\bin'
          $nsisLib = 'C:\ProgramData\chocolatey\lib\nsis'
          if (Test-Path $chocBin) {
            Add-Content -Path $env:GITHUB_PATH -Value $chocBin
            Write-Host "Added $chocBin to GITHUB_PATH"
          }
          if (Test-Path "$nsisLib\tools") {
            Add-Content -Path $env:GITHUB_PATH -Value "$nsisLib\tools"
            Write-Host "Added $nsisLib\tools to GITHUB_PATH"
          }
          # Also check common Program Files locations and add them if NSIS is installed there
          if (Test-Path "$env:ProgramFiles\NSIS") {
            Add-Content -Path $env:GITHUB_PATH -Value "$env:ProgramFiles\NSIS"
            Write-Host "Added $env:ProgramFiles\NSIS to GITHUB_PATH"
          }
          if (Test-Path "$env:ProgramFiles(x86)\NSIS") {
            Add-Content -Path $env:GITHUB_PATH -Value "$env:ProgramFiles(x86)\NSIS"
            Write-Host "Added $env:ProgramFiles(x86)\NSIS to GITHUB_PATH"
          }

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          # Install project requirements; requirements.txt references doi2bib3 via git+https
          pip install -r requirements.txt

      - name: Build with PyInstaller (use spec)
        # Run in the repository root and use the Python interpreter directly.
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          python -m PyInstaller --noconfirm quickbib.spec

      - name: Show dist contents
        shell: pwsh
        run: |
          # PowerShell-compatible listing; avoid failing the step if 'dist' doesn't exist
          if (Test-Path dist) {
            Get-ChildItem -Path dist -Force -Recurse | Sort-Object FullName | Format-Table -AutoSize
          } else {
            Write-Host "dist directory not found"
          }

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          Push-Location dist\QuickBib
          Compress-Archive -Path * -DestinationPath "../../QuickBib-Windows-portable-$version.zip"
          Pop-Location

      - name: Create installer with NSIS
        # Run makensis from the repository root; try common absolute locations if it's not on PATH
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          # Common locations where makensis.exe may be present (include literal paths to avoid env expansion issues)
          $candidates = @(
            'C:\ProgramData\chocolatey\bin\makensis.exe',
            'C:\ProgramData\chocolatey\lib\nsis\tools\makensis.exe',
            'C:\Program Files\NSIS\makensis.exe',
            'C:\Program Files (x86)\NSIS\makensis.exe'
          )

          $found = $null
          foreach ($p in $candidates) {
            if (Test-Path $p) { $found = $p; break }
          }

          # Try Get-Command (may find a shim on PATH)
          if (-not $found) {
            $cmd = Get-Command makensis -ErrorAction SilentlyContinue
            if ($cmd) { $found = $cmd.Source }
          }

          if (-not $found) {
            Write-Error "makensis not found. Checked common locations and PATH."
            Write-Host "Checked candidates:"
            $candidates | ForEach-Object { Write-Host " - $_ : " + (Test-Path $_) }
            Write-Host "Current PATH: $env:PATH"
            Write-Host "Listing C:\Program Files (x86)\NSIS (if present):"
            if (Test-Path 'C:\Program Files (x86)\NSIS') { Get-ChildItem 'C:\Program Files (x86)\NSIS' -Recurse -File | ForEach-Object { Write-Host $_.FullName } }
            exit 1
          }

          Write-Host "Using makensis at: $found"
          & $found "windows_packaging\quickbib.nsi"

      - name: Test silent user install
        shell: pwsh
        run: |
          $installer = Get-ChildItem windows_packaging/QuickBib-Installer-*.exe | Select-Object -First 1
          Write-Host "Testing installer: $($installer.FullName)"

          Write-Host "Running silent install with /S /CURRENTUSER flags..."
          # Capture output to see what the installer is doing
          & $installer.FullName /S /CURRENTUSER /D=$env:TEMP\QuickBib-Test
          $exitCode = $LASTEXITCODE
          Write-Host "Installer exit code: $exitCode"

          # Try to find install log
          Write-Host "Looking for installer log files..."
          Get-ChildItem "$env:TEMP" -Filter "*QuickBib*" -Recurse 2>$null | Select-Object -First 10 | ForEach-Object { Write-Host $_.FullName }

          Write-Host "Waiting for installation to complete..."
          Start-Sleep -Seconds 3

          Write-Host "Checking LocalAppData: $env:LOCALAPPDATA"
          $exePath = "$env:LOCALAPPDATA\Programs\QuickBib\QuickBib.exe"
          Write-Host "Looking for: $exePath"
          
          if (Test-Path "$env:LOCALAPPDATA\Programs\QuickBib") {
            Write-Host "Installation directory exists. Contents:"
            Get-ChildItem "$env:LOCALAPPDATA\Programs\QuickBib" -Recurse | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "Installation directory does not exist"
          }

          # Also check the test directory
          if (Test-Path "$env:TEMP\QuickBib-Test") {
            Write-Host "Test installation directory exists. Contents:"
            Get-ChildItem "$env:TEMP\QuickBib-Test" -Recurse | ForEach-Object { Write-Host $_.FullName }
          }
          
          if (!(Test-Path $exePath)) {
            Write-Error "Silent install failed: QuickBib.exe not found at $exePath"
            
            # Check if it installed to Program Files instead
            $altPath = "$env:ProgramFiles\QuickBib\QuickBib.exe"
            if (Test-Path $altPath) {
              Write-Host "Found installation at: $altPath"
              exit 1
            }
            
            exit 1
          }

          Write-Host "Silent install OK"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuickBib-windows-installer
          path: windows_packaging/QuickBib-Installer-*.exe

      - name: Upload portable ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuickBib-windows-portable
          path: QuickBib-Windows-portable-*.zip

      - name: Upload installer to GitHub Release (only for releases)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            windows_packaging/QuickBib-Installer-*.exe
            QuickBib-Windows-portable-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

